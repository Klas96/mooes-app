plugins {
    id "com.android.application"
    id "kotlin-android"
    // The Flutter Gradle Plugin must be applied after the Android and Kotlin Gradle plugins.
    id "dev.flutter.flutter-gradle-plugin"
    id "com.google.gms.google-services"
}

// Load keystore properties from key.properties file
def keystoreProperties = new Properties()
def keystorePropertiesFile = rootProject.file("key.properties")
if (keystorePropertiesFile.exists()) {
    keystoreProperties.load(new FileInputStream(keystorePropertiesFile))
}

android {
    namespace = "com.mooves.app"
    compileSdkVersion rootProject.ext.compileSdkVersion
    compileSdk = 36  // Required by health plugin (Android SDK 36)
    buildToolsVersion "36.0.0"  // Match Android 16 (API 36)
    ndkVersion = "26.1.10909125" // Use NDK version with toolchain file

    compileOptions {
        coreLibraryDesugaringEnabled true
        sourceCompatibility = JavaVersion.VERSION_17
        targetCompatibility = JavaVersion.VERSION_17
    }
    
    // Force resolution strategy to use Play Billing Library 6.0.1+
    // This ensures we use version 6.1.0 and reject any older AIDL-based versions
    configurations.all {
        resolutionStrategy {
            force 'com.android.billingclient:billing:6.1.0'
            force 'com.android.billingclient:billing-ktx:6.1.0'
            // Upgrade any old versions to 6.1.0
            eachDependency { DependencyResolveDetails details ->
                if (details.requested.group == 'com.android.billingclient') {
                    if (details.requested.version != null) {
                        def version = details.requested.version
                        if (version.startsWith('5.') || version.startsWith('4.') || version.startsWith('3.') || version.startsWith('2.') || version.startsWith('1.')) {
                            details.useVersion '6.1.0'
                            println "⚠️ Upgrading Play Billing Library from ${version} to 6.1.0"
                        }
                    }
                }
            }
        }
    }

    kotlinOptions {
        jvmTarget = JavaVersion.VERSION_17
    }

    defaultConfig {
        // TODO: Specify your own unique Application ID (https://developer.android.com/studio/build/application-id.html).
        applicationId = "com.mooves.app"
        // Note: This is overridden by flavor-specific applicationId settings
        // You can update the following values to match your application needs.
        // For more information, see: https://docs.flutter.dev/deployment/android#reviewing-the-gradle-build-configuration.
        minSdkVersion rootProject.ext.minSdkVersion
        targetSdkVersion rootProject.ext.targetSdkVersion
        versionCode = 233
        versionName = "134.10.16"
    }

    signingConfigs {
        release {
            // Use release keystore for Play Store and Health Connect compatibility
            if (keystorePropertiesFile.exists()) {
                try {
                    def keystorePath = keystoreProperties['storeFile']
                    // Handle both relative and absolute paths
                    if (keystorePath.startsWith('/')) {
                        storeFile file(keystorePath)
                    } else {
                        // Relative to android/app directory
                        storeFile file("../${keystorePath}")
                    }
                    storePassword keystoreProperties['storePassword']
                    keyAlias keystoreProperties['keyAlias']
                    keyPassword keystoreProperties['keyPassword']
                    println "✅ Using release keystore: ${storeFile}"
                    println "   Key alias: ${keyAlias}"
                } catch (Exception e) {
                    println "❌ Keystore configuration failed: ${e.message}"
                    println "   Falling back to debug signing"
                    storeFile file(System.getProperty("user.home") + "/.android/debug.keystore")
                    storePassword "android"
                    keyAlias "AndroidDebugKey"
                    keyPassword "android"
                }
            } else {
                // Fall back to environment variables (for CI/CD)
                def keystoreFile = System.getenv("MYAPP_UPLOAD_STORE_FILE")
                if (keystoreFile != null) {
                    storeFile file(keystoreFile)
                    storePassword System.getenv("MYAPP_UPLOAD_STORE_PASSWORD")
                    keyAlias System.getenv("MYAPP_UPLOAD_KEY_ALIAS")
                    keyPassword System.getenv("MYAPP_UPLOAD_KEY_PASSWORD")
                    println "✅ Using keystore from environment variables"
                } else {
                    // If no keystore is available, use debug signing
                    println "⚠️ Warning: No keystore available, using debug signing"
                    println "   This build is NOT suitable for Play Store"
                    storeFile file(System.getProperty("user.home") + "/.android/debug.keystore")
                    storePassword "android"
                    keyAlias "AndroidDebugKey"
                    keyPassword "android"
                }
            }
        }
    }

    buildTypes {
        release {
            // Use release signing config
            signingConfig signingConfigs.release
            minifyEnabled false
            shrinkResources false
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
        }
    }
}

flutter {
    source = "../.."
}

dependencies {
    coreLibraryDesugaring 'com.android.tools:desugar_jdk_libs:2.1.4'
    // Add missing annotation libraries for Tink cryptography
    implementation 'com.google.code.findbugs:jsr305:3.0.2'
    implementation 'javax.annotation:javax.annotation-api:1.3.2'
    implementation 'com.google.errorprone:error_prone_annotations:2.11.0'
    // Add Material Design support for Stripe compatibility
    implementation 'com.google.android.material:material:1.11.0'
    // Firebase Cloud Messaging
    implementation 'com.google.firebase:firebase-messaging:23.4.1'
    
    // Play Billing Library 6.0.1+ (required by Google Play)
    // This replaces the old AIDL-based billing library
    implementation 'com.android.billingclient:billing:6.1.0'
    implementation 'com.android.billingclient:billing-ktx:6.1.0'
}
